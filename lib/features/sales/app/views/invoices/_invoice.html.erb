<% content_for :header do %>
  <%= javascript_include_tag 'sales/invoice' %>
  <%= javascript_include_tag 'sales/sales' %>
  <%= stylesheet_link_tag_with_theme_support 'sales/invoice' %>
<% end %>

<%= generate_invoice_contextual_menu_partial %>

<% if invoice.invoice_type.nil? %>
  <%= render :partial => 'invoice_type_chooser' %>
<% else
  invoice_errors  = { :header             => invoice.errors.on(:bill_to_address) || invoice.errors.on(:invoice_contact) || invoice.errors.on(:invoice_contact_id) || invoice.errors.on(:factor) || invoice.errors.on(:factor_id) || invoice.errors.on(:invoicing_actor) || invoice.errors.on(:invoicing_actor_id) || invoice.errors.on(:published_on) ? ' errors' : '',
                      :body               => invoice.errors.on(:deposit) || invoice.errors.on(:deposit_amount) || invoice.errors.on(:deposit_vat) || invoice.errors.on(:product_items) || invoice.errors.on(:free_items) || invoice.errors.on(:invoice_items) || invoice.errors.on(:invoice_item_ids) || invoice.errors.on(:delivery_note_invoices) ? ' errors' : '',
                      :due_dates_payments => invoice.errors.on(:due_dates) || invoice.errors.on(:due_date_ids) ? ' errors' : '' }
%>
  <div class="presentation_medium root_nav standard">
    
    <% tab_navigator :invoice_nav do |t| %>
      <% t.nav_buttons do %>
        <%= t.tab :header,              "Entête",                 :class    => invoice_errors[:header],
                                                                  :selected => true %>
        <%= t.tab :body,                "Produits",               :class    => invoice_errors[:body] %>
        <%= t.tab :due_dates_payments,  "Échéances & Règlements", :class    => invoice_errors[:due_dates_payments] %>
        <%= t.tab :dunnings,            "Relances",               :disabled => true %>
        <%= t.tab_for_history(invoice) %>
      <% end %>
      
      <% action = invoice.new_record? ? :create : :update %>
      <% method = invoice.new_record? ? :put : :post %>
      <% form_for invoice, :url => { :controller => 'invoices', :action => action, :order_id => @order.id }, :method => method, :html => { :id => :invoice_form } do |form| %>
        
        <% t.content_for :header do %>
          <%= form.error_messages unless invoice_errors[:header].blank? %>
          <%= render :partial => 'invoice_header', :object => invoice, :locals => { :form => form } %>
        <% end %>
        
        <% t.content_for :body do %>
          <%= form.error_messages unless invoice_errors[:body].blank? %>
          <%= render :partial => 'invoice_body', :object => invoice, :locals => { :form => form } %>
        <% end %>
        
        <% t.content_for :due_dates_payments do %>
          <div id="due_dates">
            <% unless invoice.confirmed_at_was %>
              <%= form.error_messages unless invoice_errors[:due_dates_payments].blank? %>
              <%= render :partial => 'invoice_due_dates', :object => invoice, :locals => { :form => form } %>
            <% else %>
              <%= form.error_messages unless invoice_errors[:payments].blank? %>
              <%= render :partial => 'invoice_payments', :object => invoice %>
            <% end %>
          </div>
        <% end %>
        
        <% t.content_for :dunnings do %>
          <%# form.error_messages unless invoice_errors[:dunnings].blank? %>
          <%# render :partial => 'invoice_dunnings', :object => invoice, :locals => { :form => form }%>
        <% end %>
        
        <% t.content_for_history(invoice) %>
        
        <%= form.form_buttons %>
      <% end %>
    <% end %>
    
    <% if is_form_view? %>
      <% if invoice.deposit_invoice? %>
        <%= javascript_tag "var invoice = new DepositInvoice('invoice_form')" %>
      <% else %>
        <%= javascript_tag "var invoice = new Invoice('invoice_form')" %>
      <% end %>
    <% end %>
  </div>
<% end %>
