<%
require_locals form
invoice = invoice_body
order   = invoice.order

if invoice.new_record?
  url_prefix_for_ajax_request = order_invoicing_step_invoice_step_ajax_request_for_invoice_items_path(order)
else
  url_prefix_for_ajax_request = order_invoicing_step_invoice_step_invoice_ajax_request_for_invoice_items_path(order, invoice)
end
%>

<% if invoice.deposit_invoice? %>
  
  <div class="presentation_in_columns">
    <div>
      <p>
        <label>Montant total du devis :</label>
        <strong><span id="signed_quote_total_with_taxes"><%= invoice.signed_quote.total_with_taxes.to_f.round_to(2).to_s(2) %></span></strong><span> &euro; TTC</span>
      </p>
      
      <p>
        <%= form.label :deposit %>
        <%= form.form_or_view(form.text_field(:deposit, :size => 3, :placeholder => "0 - 100", :onkeyup => "javascript:update_deposit_amount(this)"), :deposit) %><span> &#37;</span>
      </p>
      
      <p>
        <%= form.label :deposit_amount %>
        <%= form.form_or_view(form.text_field(:deposit_amount, :value => invoice.deposit_amount.to_f.round_to(2).to_s(2), :size => 12, :onkeyup => "javascript:update_deposit_amount_without_taxes(this)"), :deposit_amount) %><span> &euro; TTC</span>
      </p>
    </div>
    
    <div class="large">
      <p>
        <label>Acompte demandé (au devis) :</label>
        <strong><%= invoice.signed_quote.deposit %></strong><span> &#37;</span>
      </p>
      
      <p>
        <%= form.label :deposit_vat %>
        <%= form.form_or_view(form.collection_select(:deposit_vat, Vat.all, :rate, :name, {}, :onchange => "javascript:update_deposit_amount_without_taxes($('invoice_deposit_amount'))"), :deposit_vat) %><span> &#37; (soit <span id="deposit_amount_without_taxes"><%= invoice.deposit_amount_without_taxes.to_f.round_to(2).to_s(2) %></span> &euro; HT)</span>
      </p>
    </div>
    
    <p>
      <%= form.label :deposit_comment %>
      <%= form.form_or_view(form.text_area_autoresize(:deposit_comment), :deposit_comment) %>
    </p>
  </div>
  
<% else %>
  
  <% if is_form_view? and ( invoice.status_invoice? or invoice.balance_invoice? ) %>
    <p>
      Le tableau ci-dessous représente les lignes de la facture. Sélectionner les "Bons de Livraison" que vous souhaitez rattacher à la facture et les lignes se mettront à jour automatiquement.
    </p>
    
    <div id="invoice_delivery_notes_picker" class="form_multiple_entries">
      <%= form.label :delivery_note_invoices %>
      <div class="collection">
        <% for delivery_note in (invoice.delivery_note_invoices.collect(&:delivery_note) + order.delivery_notes_without_confirmed_invoice).uniq %>
          <div class="object">
            <%= check_box_tag("invoice[delivery_note_invoice_attributes][]", delivery_note.id, invoice.delivery_note_invoices.reject(&:should_destroy?).collect(&:delivery_note).include?(delivery_note), :onchange => "update_invoice_items(this, '#{url_prefix_for_ajax_request}')") if is_form_view? %>
            <label>
              <%= link_to(delivery_note.reference, order_delivering_step_delivery_step_delivery_note_path(order, delivery_note)) %>
              <%= link_to(image_tag("mime_type_extensions/pdf_16x16.png"), order_delivering_step_delivery_step_delivery_note_path(order, delivery_note, :format => :pdf)) %>
            </label>
            <% if invoice.delivery_note_invoices.select{ |dni| dni.errors.any? }.collect(&:delivery_note).include?(delivery_note) %>
              <span class="fieldWithErrors"><label> * BL déjà utilisé</label></span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <div class="autoscroll">
    <table id="invoice_items" class="sales_table no_nth">
      <thead>
        <tr>
          <th rowspan="2">Réf.</th>
          <th rowspan="2">Désignation</th>
          <th rowspan="2">PU&nbsp;Brut HT&nbsp;(&euro;)</th>
          
          <th colspan="4" class="from_quote">DEVIS</th>
          
          <th colspan="4">À FACTURER (DÉJÀ LIVRÉS)</th>
          
          <% if is_form_view? %>
            <th rowspan="2">Actions</th>
          <% end %>
        </tr>
        <tr>
          <th class="from_quote">Rem (%)</th>
          <th class="from_quote">PU&nbsp;Net HT&nbsp;(&euro;)</th>
          <th class="from_quote">Qté</th>
          <th class="from_quote">Total HT&nbsp;(&euro;)</th>
          
          <th>Qté</th>
          <th>Total HT&nbsp;(&euro;)</th>
          <th>TVA</th>
          <th>Total TTC&nbsp;(&euro;)</th>
        </tr>
      </thead>
      
      <tbody id="product_invoice_items_body">
        <%= render :partial => 'invoice_items/invoice_item', :collection => invoice.sorted_product_invoice_items, :locals => { :collection_length => invoice.product_invoice_items.size } %>
      </tbody>
      <tbody id="other_invoice_items_body">
        <%= render :partial => 'invoice_items/invoice_item', :collection => invoice.sorted_other_invoice_items, :locals => { :collection_length => invoice.other_invoice_items.size } %>
      </tbody>
      
      <tfoot id="invoice_items_foot">
        <%= render :partial => 'invoices/invoice_footer', :object => invoice %>
      </tfoot>
    </table>
  </div>
  
  <table id="invoice_items_to_destroy">
    
  </table>
  
<% end %>
